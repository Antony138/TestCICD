name: Run unit test

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  run-unit-test:
    runs-on: [self-hosted, macOS, ARM64, M1, test, office]
    # runs-on: [self-hosted, macOS, ARM64, CompanyMac]

    steps:
      - name: Setup
        run: |
          ln -s /Users/runner/.rbenv/versions/3.1.2 /Users/runner/hostedtoolcache/Ruby/3.1.2/arm64
          ln -s /Users/runner/.rbenv/versions/3.1.2 /Users/runner/hostedtoolcache/Ruby/3.1.2/x86
          ln -s /Users/runner/.rbenv/versions/3.1.2 /Users/runner/hostedtoolcache/Ruby/3.1.2/x64
          touch /Users/runner/hostedtoolcache/Ruby/3.1.2/arm64.complete
          touch /Users/runner/hostedtoolcache/Ruby/3.1.2/x86.complete
          touch /Users/runner/hostedtoolcache/Ruby/3.1.2/x64.complete
          ln -fs /Users/runner/hostedtoolcache/Ruby /Users/runner/actions-runner/_work/_tool

      - name: Set up Ruby to 3.1.2
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1.2'
        env:
          ImageOS: macos12

      - name: Check out
        uses: actions/checkout@v3
        
      - name: Who am I
        run: |
          whoami
          ruby --version

      - name: Install bundler
        run: gem install bundler

      - name: Run bundle install
        run: bundle install

      - name: Run unit test
        run: bundle exec fastlane run_unit_test
        # https://docs.fastlane.tools/getting-started/ios/setup/#set-up-environment-variables
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
